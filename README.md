# 📖 시나리오 자동요약 (Scenario Auto-Summarizer)

이 확장프로그램은 **채팅 내용을 자동으로 요약**해서 AI에게 전달함으로써, 장기 롤플레이에서도 스토리 맥락을 유지할 수 있게 도와줍니다.

---

## 🔗 확장 상세 소개 게시글 보러가기

https://kkangtong.xyz/posts/16939

---

## 🎯 주요 기능 한눈에 보기

| **기능** | **설명** |
|---|---|
| 자동/수동 요약 | 일정 메시지마다 자동 요약 또는 원할 때 직접 실행 |
| 메시지 자동 숨김 | 요약 완료된 메시지는 채팅창에서 숨겨 깔끔하게 유지 |
| 등장인물 추적 | 새로운 캐릭터가 등장하면 자동으로 정보 저장 |
| 주요 이벤트 추적 | 스토리의 중요한 순간들을 자동/수동으로 기록 |
| 주요 아이템 추적 | 의미있는 아이템의 상태와 소유자를 관리 |
| 인계된 요약 시스템 | 다른 채팅방으로 요약을 누적 인계 가능 |
| 토큰 예산 관리 | 설정한 토큰 한도 내에서 요약을 AI에게 전달 |
| 분기 대응 | 채팅 분기마다 독립적으로 요약 관리 |

---

## 📑 탭별 상세 기능

### ⚙️ 설정 탭

기본적인 확장 동작을 설정하는 곳.

**활성화 토글**
- **확장 활성화**: 끄면 요약이 AI에게 전달되지 않음
- **자동 요약 모드**: 켜면 N개 메시지마다 자동으로 요약 실행

**기본 설정**
- **자동 요약 간격**: 몇 개 메시지마다 자동 요약할지 설정 (예: 10개마다)
- **API 호출당 처리량**: 한 번에 몇 개 메시지를 묶어서 요약할지
- **최근 메시지 보존 수**: 최근 N개 메시지는 숨기지 않고 표시

**자동화 옵션**
- **자동 숨김**: 요약 완료된 메시지를 채팅창에서 자동으로 숨김
- **등장인물 추적**: 요약 시 새로운 캐릭터 정보를 자동 추출·저장
- **이벤트 추적**: 주요 스토리 이벤트를 자동 추출·저장
- **아이템 추적**: 의미있는 아이템 정보를 자동 추출·저장

**토큰 & 컨텍스트**
- **토큰 예산**: AI에게 전달할 요약의 최대 토큰 수. 초과하면 오래된 요약부터 제외
- **이전 요약 참조**: 요약 생성 시 이전 요약들을 얼마나 참고할지 (일관성 유지용)

**프롬프트 주입 설정**
- **주입 위치**: 요약을 프롬프트 어디에 넣을지 선택
  - `채팅 내`: 채팅 히스토리 안에 삽입 (depth 설정 가능)
  - `메인 프롬프트 앞`: 시스템 프롬프트 앞에 배치
  - `메인 프롬프트 뒤`: 시스템 프롬프트 뒤에 배치
- **주입 깊이**: 채팅 내 삽입 시 얼마나 깊이 넣을지 (0 = 가장 최근)
- **월드인포 포함**: 요약에 월드인포(로어북) 내용도 함께 전달

**요약 모드**
- **개별 요약**: 메시지마다 별도 요약 생성 (상세하지만 토큰 사용↑)
- **묶음 요약**: 여러 메시지를 하나로 통합 (간결하고 토큰 절약)

**요약 항목**

시나리오, 감정, 속마음, 분위기, 장소, 날짜, 시간, 관계 등 항목을 선택 가능.
- 필요한 항목만 켜서 요약에 포함
- 각 항목의 프롬프트도 직접 수정 가능
- 드래그로 순서 변경 가능

**UI 테마**

7가지 색상 테마 제공: Mono Gray, Dusty Rose, Ocean Breeze, Matcha Garden, Dark Mono, Strawberry Milk, Butter Cream

---

### 🔌 API 탭

요약 생성에 사용할 API를 설정하는 곳.

**API 소스 선택**
- **SillyTavern API 사용**: 현재 연결된 API 또는 Connection Profile 그대로 사용
- **커스텀 API 사용**: OpenAI 등 별도 API 엔드포인트를 직접 설정

**SillyTavern 옵션**
- Connection Profile 선택 가능
- Raw 프롬프트 모드 지원 (채팅 히스토리 제외하고 캐릭터 정보만 전송)

**커스텀 API 설정**
- URL, API Key, 모델 직접 입력
- Max Tokens, 타임아웃 설정
- 자주 쓰는 설정을 **프리셋**으로 저장/불러오기 가능

**API 연결 테스트**: 버튼 하나로 연결 상태 확인

---

### 📊 상태 탭

현재 요약 현황을 확인하고 요약을 실행하는 곳.

**현재 상태 통계**
- 전체 메시지 수
- 요약 완료된 메시지 수
- 요약 대기 중인 메시지 수
- 숨겨진 메시지 수
- 다음 자동 요약까지 남은 메시지 수
- **오류 카운트**: 파싱 실패한 요약 개수 표시 (클릭 시 일괄 재생성)
- **토큰 사용량**: 프롬프트에 주입될 토큰 수 실시간 표시

**수동 요약 실행**
- **지금 요약**: 미요약 메시지를 즉시 요약
- **범위 지정**: 특정 구간(예: 0~50번)만 요약 가능
- 진행률 표시 및 **중단 버튼** 제공

**요약 검색**
- 저장된 요약 내용을 키워드로 검색

**요약 미리보기**
- 저장된 요약을 확인하고 페이지 넘기기 가능
- **정렬 순서 토글**: 최신순/오래된순 전환
- 클립보드에 복사 기능

**데이터 관리**
- **내보내기/가져오기**: 요약 데이터를 JSON 파일로 백업·복원
- **인계된 요약으로 가져오기**: 다른 채팅방 요약을 새 채팅방으로 누적 인계 (A→B→C→D→...)
- **숨김 해제**: 숨긴 메시지를 다시 표시
- **에러 로그**: 오류 발생 시 확인 가능

**초기화**
- 현재 채팅의 요약, 인계된 요약, 등장인물, 이벤트, 아이템 데이터 개별 선택 삭제

---

### 📚 도감 탭

롤플레이에 등장하는 캐릭터, 이벤트, 아이템을 관리하는 곳.

**등장인물 목록**
- 추출된 모든 캐릭터 정보를 카드 형태로 표시
- 이름, 역할, 나이, 직업, 설명, 특성, 관계 등 상세 정보

**주요 이벤트 도감 📅**
- 스토리의 중요한 순간들을 자동/수동으로 기록
- 첫 고백, 결혼, 중요한 약속, 관계 변화 등
- 중요도 설정 (높음/보통/낮음)
- 참여 캐릭터 연동
- 첫 등장 메시지 번호 기록

**주요 아이템 도감 🎒**
- 스토리에서 의미있는 아이템 관리
- 커플링, 선물 등 중요 아이템
- 상태 관리 (보유중/사용함/분실/양도/파손...)
- 획득 경위 기록
- 소유자 추적

**인물/이벤트/아이템 추출/추가**
- **AI로 추출**: 현재까지의 채팅 내용에서 자동 추출
- **수동 추가**: 직접 정보 입력

**관리 기능**
- 클립보드 복사 / JSON 파일 내보내기 / 가져오기
- 각각 개별 초기화 가능

---

### 📝 프롬프트 탭

AI에게 전달할 요약 지침을 커스터마이징하는 곳.

**5가지 프롬프트 유형**
- **개별 요약 프롬프트**: 메시지별 요약 시 사용되는 지침
- **묶음 요약 프롬프트**: 여러 메시지를 통합 요약할 때 사용
- **등장인물 추출 프롬프트**: 캐릭터 정보 추출 시 사용
- **이벤트 추출 프롬프트**: 주요 이벤트 추출 시 사용
- **아이템 추출 프롬프트**: 주요 아이템 추출 시 사용

**프롬프트 프리셋**
- 자주 쓰는 프롬프트를 **프리셋으로 저장**
- 필요할 때 불러오기/삭제

**기본값 복원**
- 수정한 프롬프트를 언제든 기본값으로 되돌리기 가능

**프롬프트 구조 안내**

AI에게 전송되는 최종 프롬프트는 다음 순서로 자동 구성됨:
1. 언어 설정 (자동)
2. 사용자 작성 지침 (수정 가능)
3. 이전 상태 - 시간/장소/관계 (자동)
4. 기존 등장인물 정보 (자동)
5. 요약할 메시지 내용 (자동)
6. 출력 형식 (자동)

---

## 💾 데이터 저장 및 관리 방식

- 요약 데이터는 SillyTavern의 **chatMetadata**에 별도로 저장.
- 채팅 파일과 함께 자동 저장되므로 별도의 백업이 필요 없음.
- **채팅별 독립 요약 관리**:
  - 각 채팅창(분기)마다 요약 데이터가 별도로 유지.
  - 예: 300챗 진행 중 240챗에서 분기 생성 시, 새 분기는 240번까지만 요약을 인식하며 이후에는 독립적으로 진행.
- 데이터 내보내기/가져오기로 JSON 파일 백업·복원 가능.

---

## ✨ 이 확장의 장점

1. **토큰 효율성**
   - 전체 채팅을 보내는 대신 압축된 요약만 전달 → 토큰 절약

2. **채팅창 정리**
   - 요약된 메시지를 숨겨 현재 진행 상황에만 집중

3. **등장인물 자동 추적**
   - 새 캐릭터가 나올 때마다 일일이 메모할 필요 없음

4. **분기 완벽 대응**
   - 분기점마다 요약이 독립적으로 관리되어 혼선 없음

5. **유연한 커스터마이징**
   - 요약 항목, 프롬프트, 언어, 테마까지 세세하게 조정 가능

---

## 📥 설치 방법

1. SillyTavern 열기
2. Extensions > Install Extension 이동
3. 저장소 URL 입력: `https://github.com/NovaCaso01/Scenario-Summarizer`
4. Install 클릭
5. SillyTavern 새로고침

---

## 📄 라이선스

이 프로젝트는 **GNU Affero General Public License v3.0 (AGPL-3.0)** 하에 배포됩니다.

### 참고 및 감사

이 확장프로그램의 일부 코드 구조는 [OpenVault](https://github.com/unkarelian/openvault) 프로젝트를 참고하였습니다.
OpenVault는 AGPL-3.0 라이선스로 배포되며, 본 프로젝트도 동일한 라이선스를 따릅니다.

---

### License

This project is licensed under **GNU Affero General Public License v3.0 (AGPL-3.0)**.

Some code structure of this extension was referenced from the [OpenVault](https://github.com/unkarelian/openvault) project.
OpenVault is distributed under AGPL-3.0 license, and this project follows the same license.

---

## 📌 Version

v1.2.0

### v1.2.0 변경사항 (2026.02.14)

**✨ 새로운 기능**
- **압축 요약**: 기존 요약들을 AI가 더 짧게 압축해주는 기능 추가 (토큰 절약)
  - 전체/최근/오래된 요약 중 선택하여 압축 가능
  - 배치 단위 처리로 안정적인 압축 (25개씩)
  - 압축 전 자동 백업 파일 다운로드
  - 압축 결과 미리보기 후 적용 가능
  - 실시간 진행률 표시 및 중단 기능
  - 토큰 절약량 표시

- **프리필 프롬프트**: 모든 API 요청에 프리필 텍스트 자동 추가
  - AI가 서문 없이 바로 지시된 형식으로 응답하도록 유도
  - 검열 완화 프롬프트와 함께 자동 적용
  
- **요약 핀 고정**: 중요한 요약을 핀으로 고정
  - 토큰 예산 초과 시에도 핀 고정된 요약은 우선 포함
  - 핀 고정만 모아보기 필터
  - 압축 요약 시에도 핀 고정 요약 포함됨
  
- **사용자 메모**: 각 요약에 개인 메모 추가 가능
  - 검색 시 메모 내용도 함께 검색
  - AI에게는 전달되지 않음 (사용자 전용)
  
- **요약 일괄 관리**: 선택한 요약 항목(Time/Date 등)들을 한 번에 삭제 가능

**🎨 UI/UX 개선**
- 미전달 요약 시각적 구분 강화 (구분선 + 뱃지)

**🔧 기술 개선**
- 상태 마커 상수화로 코드 품질 향상
- 중복 함수 통합 (코드 정리)